# .github/workflows/classroom-maven.yml
name: Autograde

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21 and cache Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run tests with Maven Wrapper
        id: test
        run: |
          chmod +x mvnw
          ./mvnw test -B
        continue-on-error: true

      - name: Parse JUnit results
        id: parse
        if: always() && success() || failure()
        uses: dorny/test-reporter@v2
        with:
          name: JUnit Results
          path: "**/target/surefire-reports/*.xml"
          reporter: java-junit
          fail-on-empty: false
          fail-on-error: false

      - name: Calculate total tests
        id: calc-total
        run: |
          passed=${{ steps.parse.outputs.passed || 0 }}
          failed=${{ steps.parse.outputs.failed || 0 }}
          skipped=${{ steps.parse.outputs.skipped || 0 }}
          total=$((passed + failed + skipped))
          echo "total=$total" >> $GITHUB_OUTPUT

      - name: Grade JUnit test scores
        id: grade-junit
        uses: cbfacademy/autograding-command-grader@dev
        with:
          test-name: JUnit-Suite
          command: |
            ./.github/workflows/grade-junit.sh ${{ steps.parse.outputs.passed || 0 }} ${{ steps.parse.outputs.failed || 0 }} ${{ steps.parse.outputs.skipped || 0 }}
          max-score: 70

      - name: Test output
        run: |
          result=$(echo "${{steps.grade-junit.outputs.result}}" | base64 -d)
          echo "GRADE-JUNIT_RESULTS: $result"

      - name: Autograding Reporter
        uses: cbfacademy/autograding-grading-reporter@dev
        env:
          GRADE-JUNIT_RESULTS: "${{steps.grade-junit.outputs.result}}"
        with:
          runners: grade-junit
 
